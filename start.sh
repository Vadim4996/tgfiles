#!/bin/bash

cd "$(dirname "$0")"   # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ –∏–∑ –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ Debian/Linux
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./start.sh

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ Telegram Mini App..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ tmux
if command -v tmux &> /dev/null; then
    echo "üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º tmux –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞..."
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é tmux
    tmux new-session -d -s miniapp
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫–µ–Ω–¥ –≤ –ø–µ—Ä–≤–æ–º –æ–∫–Ω–µ (HOST=0.0.0.0)
    tmux send-keys -t miniapp "cd server && HOST=0.0.0.0 node app.js" C-m
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ç–æ—Ä–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
    tmux new-window -t miniapp -n frontend
    tmux send-keys -t miniapp:frontend "pnpm run dev" C-m
    
    # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–µ—Å—Å–∏—é
    tmux attach-session -t miniapp
    
else
    echo "üì¶ tmux –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –≤ —Ñ–æ–Ω–µ..."
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫–µ–Ω–¥ –≤ —Ñ–æ–Ω–µ (HOST=0.0.0.0)
    echo "üîß –ó–∞–ø—É—Å–∫ –±—ç–∫–µ–Ω–¥–∞..."
    cd server && HOST=0.0.0.0 node app.js &
    BACKEND_PID=$!
    cd ..  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
    # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
    sleep 2
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
    echo "üé® –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
    cd "$(dirname "$0")"  # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ –∏–∑ –ø–∞–ø–∫–∏ —Å package.json
    pnpm run dev &
    FRONTEND_PID=$!
    
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!"
    echo "üîß –ë—ç–∫–µ–Ω–¥ PID: $BACKEND_PID"
    echo "üé® –§—Ä–æ–Ω—Ç–µ–Ω–¥ PID: $FRONTEND_PID"
    echo ""
    echo "üì± –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://localhost:5173"
    echo "üîå –ë—ç–∫–µ–Ω–¥: http://localhost:3001"
    echo ""
    echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
    
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    wait
fi 